<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>EndPlay</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Chessboard.js -->
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" />
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <!-- Chess.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <style>
    #myBoard {
      width: 400px;
      margin: 20px auto;
    }

    #promotionSelector {
      visibility:hidden;
      text-align: center;
      margin-top: 10px;
      height: 40px;
    }

    #promotionSelector.show {
    visibility: visible;
    }

    #promotionSelector button {
      font-size: 20px;
      margin: 0 5px;
    }
  </style>
</head>

<body>

<div style="text-align: center; margin-top: 20px;">
  <textarea id="fenInput" placeholder="Enter FEN..." rows="3" style="width: 20%; resize: vertical;"></textarea>
  <button onclick="loadFEN()">Load FEN</button>
</div>

<div id="promotionSelector">
  Promote to:
  <button onclick="handlePromotionChoice('q')">♛</button>
  <button onclick="handlePromotionChoice('r')">♜</button>
  <button onclick="handlePromotionChoice('b')">♝</button>
  <button onclick="handlePromotionChoice('n')">♞</button>
</div>

<div id="myBoard"></div>

<script>
  const game = new Chess();
  let board = null;
  let pendingPromotion = null;

  function onDrop(source, target) {
    const piece = game.get(source);
    const isPromotion =
      piece && piece.type === 'p' &&
      ((piece.color === 'w' && target[1] === '8') ||
       (piece.color === 'b' && target[1] === '1'));

    if (isPromotion) {
      pendingPromotion = { from: source, to: target };
      document.getElementById("promotionSelector").classList.add("show");
      return "snapback"; // wait for promotion choice
    }

    return tryMove(source, target);
  }

  function handlePromotionChoice(promotion) {
    const { from, to } = pendingPromotion;
    pendingPromotion = null;
    document.getElementById("promotionSelector").classList.remove("show");
    tryMove(from, to, promotion);
  }

  function tryMove(from, to, promotion) {
    const move = game.move({ from, to, promotion });

    if (move === null) {
      return "snapback";
    }

    const moveStr = from + to + (promotion || "");

    fetch("/move", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ move: moveStr })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert("Server rejected move: " + data.error);
        game.undo();
        board.position(game.fen());
        return;
      }
      game.load(data.fen);
      board.position(data.fen);
    })
    .catch(err => {
      console.error(err);
      alert("Server error");
      game.undo();
      board.position(game.fen());
    });
  }

  function onSnapEnd() {
    board.position(game.fen());
  }

  function loadFEN() {
    const fenText = document.getElementById('fenInput').value.trim();
    fetch("/set_fen", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fen: fenText })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert("Error loading FEN");
        return;
      }
      board.position(data.fen);
      game.load(data.fen);
    })
    .catch(err => {
      console.error("Request failed:", err);
      alert("Something went wrong while loading the FEN.");
    });
  }

  board = Chessboard("#myBoard", {
    draggable: true,
    position: "start",
    pieceTheme: "https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
    onDrop: onDrop,
    onSnapEnd: onSnapEnd
  });
</script>

</body>
</html>